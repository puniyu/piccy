name: Build Tauri App

on:
  workflow_call:
    secrets:
      STORE_PASSWORD:
        required: true
      KEY_ALIAS:
        required: true
      KEY_PASSWORD:
        required: true
      BASE64_JKS:
        required: true

env:
  APP_NAME: piccy

jobs:
  build_windows:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: windows-latest
            target: x86_64-pc-windows-msvc
            label: windows-x86_64

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: é…ç½® taui cli
        uses: taiki-e/install-action@v2
        with:
          tool: tauri-cli

      - name: è®¾ç½® rust ç¼“å­˜
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: ${{ env.APP_NAME }}
          shared-key: app-${{ matrix.platform.label }}
          workspaces: piccy_app

      - name: é…ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: æž„å»º
        run: |
          pnpm install
          cargo tauri build --target ${{ matrix.platform.target }}
        working-directory: piccy_app

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ matrix.platform.label }}"
          path: |
            target/${{ matrix.platform.target }}/release/bundle/nsis/${{ env.APP_NAME }}*.exe

      - name: ç”Ÿæˆæž„å»ºä¿¡æ¯
        run: |
          VERSION=$(jq -r '.version' piccy_app/tauri.conf.json)
          NAME=$(jq -r '.productName' piccy_app/tauri.conf.json)
          
          echo "## ðŸ–¥ï¸ Windowsæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨åç§°:** \`$NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** \`${{ matrix.platform.label }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

  build_linux:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            label: linux-x86_64
          - runner: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            label: linux-aarch64

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android x86_64-linux-android armv7-linux-androideabi i686-linux-android

      - name: é…ç½® taui cli
        uses: taiki-e/install-action@v2
        with:
          tool: tauri-cli

      - name: é…ç½® webkit

        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: é…ç½®arm64
        if: ${{ matrix.platform.label == 'linux-aarch64' }}
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: gcc-aarch64-linux-gnu libwebkit2gtk-4.1-dev:arm64

      - name: è®¾ç½® rust ç¼“å­˜
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: ${{ env.APP_NAME }}
          shared-key: app-${{ matrix.platform.label }}
          workspaces: piccy_app

      - name: é…ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: æž„å»º
        run: |
          pnpm install
          cargo tauri build --target ${{ matrix.platform.target }}
        working-directory: piccy_app

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ matrix.platform.label }}"
          path: |
            target/${{ matrix.platform.target }}/release/bundle/deb/${{ env.APP_NAME }}*.deb

      - name: ç”Ÿæˆæž„å»ºä¿¡æ¯
        run: |
          VERSION=$(jq -r '.version' piccy_app/tauri.conf.json)
          NAME=$(jq -r '.productName' piccy_app/tauri.conf.json)
          
          echo "## ðŸ–¥ï¸ Linuxæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ–¥ï¸ Androidæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨åç§°:** \`$NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** \`${{ matrix.platform.label }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

  build_android:
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      matrix:
        platform:
          - runner: ubuntu-latest
            target: aarch64-linux-android
            label: android-aarch64

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - name: é…ç½® taui cli
        uses: taiki-e/install-action@v2
        with:
          tool: tauri-cli

      - name: é…ç½® webkit
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: é…ç½®ndk
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27d

      - name: è®¾ç½® rust ç¼“å­˜
        uses: swatinem/rust-cache@v2
        with:
          prefix-key: ${{ env.APP_NAME }}
          shared-key: app-${{ matrix.platform.label }}
          workspaces: piccy_app

      - name: é…ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: è®¾ç½® Android ç­¾å
        run: |
          echo "storeFile=keystore.jks" > keystore.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> keystore.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> keystore.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> keystore.properties
          echo "${{ secrets.BASE64_JKS }}" | base64 --decode > app/keystore.jks

        working-directory: piccy_app/gen/android


      - name: æž„å»º
        run: |
          pnpm install
          cargo tauri android build
        env:
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        working-directory: piccy_app

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.APP_NAME }}-${{ matrix.platform.label }}"
          path: |
            piccy_app/gen/android/app/build/outputs/apk/universal/release/app-universal-release.apk

      - name: ç”Ÿæˆæž„å»ºä¿¡æ¯
        run: |
          VERSION=$(jq -r '.version' piccy_app/tauri.conf.json)
          NAME=$(jq -r '.productName' piccy_app/tauri.conf.json)
          
          echo "## ðŸ–¥ï¸ Androidæ¡Œé¢åº”ç”¨æž„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨åç§°:** \`$NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°:** \`${{ matrix.platform.label }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

            

